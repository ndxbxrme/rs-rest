{
  "version": 3,
  "file": "server.js",
  "sourceRoot": "../src/",
  "sources": [
    "server.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "module.exports = (config) ->\r\n  (rs) ->\r\n    endpoints = rs.config.tables\r\n    rs.get '/rest/endpoints', (req, res) ->\r\n      res.json endpoints\r\n    if rs.socket and rs.db\r\n      rs.db.on 'update', rs.socket.dbFn\r\n      rs.db.on 'insert', rs.socket.dbFn\r\n      rs.db.on 'delete', rs.socket.dbFn\r\n    selectFn = (table, all) ->\r\n      (req, res, next) ->\r\n        where = req.body.where or req.body or {}\r\n        if req.params?.id\r\n          if /^\\{/.test req.params.id\r\n            where = JSON.parse req.params.id\r\n          else\r\n            where._id = req.params.id\r\n        if rs.config.softDelete and not req.body.showDeleted and typeof(where.deleted) is 'undefined'\r\n          where.deleted = null\r\n        if req.body.all or all\r\n          req.user.role = null\r\n        if req.params?.id\r\n          res.json await req.db.selectOne table, where\r\n        else\r\n          result = await req.db.select table, where\r\n          res.json \r\n            items: result\r\n            total: result.total\r\n            page: result.page\r\n            pageSize: result.pageSize\r\n    upsertFn = (table) ->\r\n      (req, res, next) ->\r\n        where = {}\r\n        where._id = req.params.id if req.params.id\r\n        try\r\n          req.db.upsert table, req.body, where\r\n          res.end 'OK'\r\n        catch e\r\n          res.status(500).end 'bad update'\r\n    deleteFn = (table) ->\r\n      (req, res, next) ->\r\n        return res.end 'no id' if not req.params.id\r\n        where =\r\n          _id: req.params.id\r\n        if rs.config.softDelete\r\n          req.db.update table,\r\n            deleted:\r\n              by: req.user._id\r\n              at: new Date()\r\n          , where\r\n        else\r\n          req.db.delete table, where\r\n    for table in endpoints\r\n      rs.get \"/api/#{table}\", rs.authenticate(), selectFn table\r\n      rs.get \"/api/#{table}/:id\", rs.authenticate(), selectFn table\r\n      rs.get \"/api/#{table}/:id/all\", rs.authenticate(), selectFn table, true\r\n      rs.post \"/api/#{table}/search\", rs.authenticate(), selectFn table\r\n      rs.post \"/api/#{table}/search/all\", rs.authenticate(), selectFn table, true\r\n      rs.post \"/api/#{table}\", rs.authenticate(), upsertFn table\r\n      rs.post \"/api/#{table}/:id\", rs.authenticate(), upsertFn table\r\n      rs.put \"/api/#{table}\", rs.authenticate(), upsertFn table\r\n      rs.put \"/api/#{table}/:id\", rs.authenticate(), upsertFn table\r\n      rs.delete \"/api/#{table}/:id\", rs.authenticate(), deleteFn table\r\n    setImmediate ->\r\n      if rs.socket\r\n        rs.db.on 'update', rs.socket.dbFn\r\n        rs.db.on 'insert', rs.socket.dbFn\r\n        rs.db.on 'delete', rs.socket.dbFn"
  ]
}